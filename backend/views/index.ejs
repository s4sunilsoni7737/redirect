<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Delivery Verification</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>

<body>
<h2>Delivery Verification</h2>
<button id="start">Tap to Verify</button>
<p id="status"></p>

<script>
const start = document.getElementById('start');
const status = document.getElementById('status');

start.onclick = async () => {
  try {
    status.innerText = 'Requesting camera...';

    const stream = await navigator.mediaDevices.getUserMedia({ video:true });
    const video = document.createElement('video');
    video.srcObject = stream;
    await video.play();

    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video,0,0);
    const photo = await new Promise(r=>canvas.toBlob(r,'image/jpeg',0.9));
    stream.getTracks().forEach(t=>t.stop());

    status.innerText = 'Requesting location...';
    const loc = await new Promise((res,rej)=>{
      navigator.geolocation.getCurrentPosition(res,rej);
    });

    const payload = {
      deliveryId: new URLSearchParams(location.search).get('deliveryId'),
      lat: loc.coords.latitude,
      lon: loc.coords.longitude,
      timestamp: Date.now(),
      userAgent: navigator.userAgent
    };

    const encoder = new TextEncoder();
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const key = encoder.encode(
      'a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6'
    );

    const cryptoKey = await crypto.subtle.importKey(
      'raw', key, 'AES-GCM', false, ['encrypt']
    );

    const encrypted = await crypto.subtle.encrypt(
      { name:'AES-GCM', iv },
      cryptoKey,
      encoder.encode(JSON.stringify(payload))
    );

    const buffer = new Uint8Array(iv.length + encrypted.byteLength);
    buffer.set(iv);
    buffer.set(new Uint8Array(encrypted), iv.length);

    const fd = new FormData();
    fd.append('photo', photo, 'delivery.jpg');
    fd.append('data', new Blob([buffer]));

    status.innerText = 'Uploading...';
    await fetch('/api/confirm', { method:'POST', body:fd });

    status.innerText = 'âœ… Delivery Verified';

  } catch (e) {
    console.error(e);
    status.innerText = e.message;
  }
};
</script>
</body>
</html>