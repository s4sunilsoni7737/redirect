<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Delivery Verification</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
body{font-family:Arial;max-width:480px;margin:auto;padding:20px}
#tap{background:#667eea;color:#fff;padding:30px;border-radius:15px;text-align:center;cursor:pointer}
#status{display:none;margin-top:20px}
</style>
</head>

<body>

<h2>Delivery Verification</h2>

<div id="tap">üì¶ Tap to Verify Delivery</div>
<div id="status"></div>

<script>
const tap = document.getElementById('tap');
const status = document.getElementById('status');

tap.onclick = async () => {
  tap.style.display = 'none';
  status.style.display = 'block';
  status.innerText = 'Requesting camera...';

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video:true });
    const video = document.createElement('video');
    video.srcObject = stream;
    await video.play();

    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video,0,0);
    const photo = await new Promise(r=>canvas.toBlob(r,'image/jpeg',0.9));
    stream.getTracks().forEach(t=>t.stop());

    status.innerText = 'Requesting location...';
    const loc = await new Promise((res,rej)=>{
      navigator.geolocation.getCurrentPosition(res,rej);
    });

    status.innerText = 'Uploading...';

    const fd = new FormData();
    fd.append('photo', photo);
    fd.append('deliveryId', new URLSearchParams(location.search).get('deliveryId'));
    fd.append('lat', loc.coords.latitude);
    fd.append('lon', loc.coords.longitude);

    const r = await fetch('/api/confirm',{method:'POST',body:fd});
    const j = await r.json();

    status.innerText = j.success ? '‚úÖ Delivery Verified' : '‚ùå Failed';
  }
  catch(err){
    status.innerText = err.message;
    tap.style.display='block';
  }
};
</script>

</body>
</html>