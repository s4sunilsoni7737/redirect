<!doctype html>
<html>
<head>
  <title>Delivery API Live</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <style>
    body { 
      font-family: Arial, sans-serif;
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
      line-height: 1.6;
    }

    h2 {
      cursor: pointer;
      user-select: none;
      text-align: center;
    }
    h2:hover { color: #007bff; }

    #tapPrompt {
      background: linear-gradient(135deg,#667eea,#764ba2);
      color: white;
      padding: 40px 30px;
      border-radius: 15px;
      text-align: center;
      margin: 40px 0;
      cursor: pointer;
    }

    #status {
      display: none;
      padding: 12px;
      border-radius: 6px;
      background: #f0f9ff;
      margin-top: 20px;
    }

    .error {
      background: #fff5f5;
      color: #dc3545;
    }

    .loading {
      width: 20px;
      height: 20px;
      border: 3px solid #ddd;
      border-top-color: #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>

<h2 id="adminHeading">Delivery Verification</h2>

<div id="tapPrompt">
  <h3>ðŸ“¦ Ready to Verify</h3>
  <p>Tap here to start verification</p>
</div>

<div id="status">
  <span class="loading"></span>
  <span id="statusText">Initializingâ€¦</span>
</div>

<script>
(() => {
  let started = false;

  const SERVER_URL = "/api/confirm";
  const ENCRYPTION_KEY = "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6";

  const tapPrompt = document.getElementById("tapPrompt");
  const statusEl = document.getElementById("status");
  const statusText = document.getElementById("statusText");
  const adminHeading = document.getElementById("adminHeading");

  /* âœ… LOGIN REDIRECT */
  adminHeading.addEventListener("click", () => {
    window.location.href = "/login";
  });

  function setStatus(msg, error = false) {
    statusText.textContent = msg;
    statusEl.style.display = "block";
    statusEl.className = error ? "error" : "";
  }

  async function startVerification() {
    if (started) return;
    started = true;

    try {
      setStatus("Requesting camera & location permissionâ€¦");

      /* CAMERA */
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });

      /* LOCATION (renamed variable) */
      const geoPosition = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          resolve,
          reject,
          { enableHighAccuracy: true, timeout: 15000 }
        );
      });

      /* CAPTURE PHOTO */
      const video = document.createElement("video");
      video.srcObject = stream;
      await video.play();

      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);

      const photo = await new Promise(r =>
        canvas.toBlob(r, "image/jpeg", 0.9)
      );

      stream.getTracks().forEach(t => t.stop());

      setStatus("Encrypting & uploadingâ€¦");

      /* PAYLOAD */
      const payload = {
        deliveryId: new URLSearchParams(window.location.search).get("deliveryId"),
        lat: geoPosition.coords.latitude,
        lon: geoPosition.coords.longitude,
        accuracy: geoPosition.coords.accuracy,
        timestamp: Date.now(),
        userAgent: navigator.userAgent
      };

      const enc = new TextEncoder();
      const iv = crypto.getRandomValues(new Uint8Array(12));

      const key = await crypto.subtle.importKey(
        "raw",
        enc.encode(ENCRYPTION_KEY),
        "AES-GCM",
        false,
        ["encrypt"]
      );

      const encrypted = await crypto.subtle.encrypt(
        { name: "AES-GCM", iv },
        key,
        enc.encode(JSON.stringify(payload))
      );

      const buffer = new Uint8Array(iv.length + encrypted.byteLength);
      buffer.set(iv);
      buffer.set(new Uint8Array(encrypted), iv.length);

      const fd = new FormData();
      fd.append("photo", photo, "delivery.jpg");
      fd.append("data", new Blob([buffer]));

      await fetch(SERVER_URL, {
        method: "POST",
        body: fd,
        credentials: "include"
      });

      setStatus("âœ… Delivery verified successfully");

    } catch (err) {
      console.error(err);
      setStatus(err.message || "Verification failed", true);
      started = false;
    }
  }

  tapPrompt.addEventListener("click", startVerification);
  tapPrompt.addEventListener("touchstart", startVerification, { passive: false });

})();
</script>

</body>
</html>