<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body { font-family: Arial; padding: 16px; }
.card {
  border: 1px solid #ccc; border-radius: 8px; padding: 12px; margin-bottom: 16px;
}
.card img { 
  max-width: 100%;
  max-height: 300px;
  width: auto;
  height: auto;
  display: block;
  margin: 12px auto;
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  border: 1px solid #e0e0e0;
  object-fit: contain;
  background: #f8f8f8;
}
.map {
    width: 100%;
    height: 300px;
    background: #f0f0f0;
    border-radius: 6px;
    margin: 12px 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    position: relative;
}

.map::before {
    content: 'Loading map...';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #666;
    font-style: italic;
}
</style>
</head>

<body>
<h2>ðŸ“¦ Delivery Dashboard</h2>
<p>Showing confirmations with photo, location, and timestamp.</p>

<div id="list"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
async function loadData() {
  const res = await fetch("/api/list");
  const data = await res.json();

  const list = document.getElementById("list");
  list.innerHTML = "";

  data.items.forEach((item, index) => {
    // Convert and validate coordinates
    const lat = Number(item.lat);
    const lon = Number(item.lon);

    if (isNaN(lat) || isNaN(lon)) {
      console.warn("Invalid coordinates:", item.lat, item.lon);
      return;
    }
    
    const div = document.createElement("div");
    div.className = "card";
    const mapId = `map-${Date.now()}-${index}`;

    const date = new Date(item.receivedAt).toLocaleString();

    div.innerHTML = `
      <b>Delivery ID:</b> ${item.deliveryId || 'N/A'} <br>
      <b>Time:</b> ${date} <br>
      <b>Location:</b> ${lat.toFixed(6)}, ${lon.toFixed(6)} <br>
      <b>Accuracy:</b> ${item.accuracy ? item.accuracy + ' meters' : 'N/A'}

      ${item.imageUrl ? `<img src="${item.imageUrl}" alt="Delivery photo" onerror="this.style.display='none';">` : ''}

      <div id="${mapId}" class="map"></div>

      <a href="https://www.google.com/maps?q=${lat},${lon}&z=17" target="_blank">
        Open in Google Maps
      </a>
    `;

    list.appendChild(div);
    
    // Initialize map after the element is in the DOM
    setTimeout(() => {
      try {
        const map = L.map(mapId, {
          center: [lat, lon],
          zoom: 16,
          zoomControl: true
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: ' OpenStreetMap contributors'
        }).addTo(map);

        // Add a circle to show accuracy
        if (item.accuracy) {
          L.circle([lat, lon], {
            radius: parseFloat(item.accuracy),
            color: '#3388ff',
            fillColor: '#3388ff',
            fillOpacity: 0.2
          }).addTo(map);
        }

        // Add marker with popup
        L.marker([lat, lon])
          .addTo(map)
          .bindPopup(`
            <b>Delivery ID:</b> ${item.deliveryId || 'N/A'}<br>
            <b>Time:</b> ${date}<br>
            <b>Accuracy:</b> ${item.accuracy ? item.accuracy + 'm' : 'N/A'}
          `)
          .openPopup();

        // Small delay to ensure map container is properly sized
        setTimeout(() => map.invalidateSize(), 50);
      } catch (error) {
        console.error('Error initializing map:', error);
        const mapDiv = document.getElementById(mapId);
        if (mapDiv) {
          mapDiv.innerHTML = 'Error loading map. <a href="https://www.google.com/maps?q=' + 
            item.lat + ',' + item.lon + '" target="_blank">View in Google Maps</a>';
        }
      }
    }, 100);
  });
}

loadData();
// Disable auto-refresh to prevent map recreation issues
// setInterval(loadData, 10000); // auto-refresh every 10 seconds
</script>

</body>
</html>
